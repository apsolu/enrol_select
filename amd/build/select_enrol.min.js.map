{"version":3,"file":"select_enrol.min.js","sources":["../src/select_enrol.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module javascript.\n *\n * @todo       Description à compléter.\n *\n * @module     enrol_select/select_enrol\n * @copyright  2016 Université Rennes 2 <dsi-contact@univ-rennes2.fr>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery'], function($) {\n    return {\n        initialise: function(wwwroot) {\n            // Ajoute une div pour accueil les différents formulaires en overlay...\n            $('body').append('<div id=\"apsolu-enrol-form\"></div>');\n\n            // Permet de déplier/replier la liste des activités.\n            var tooglebutton = document.getElementById('apsolu-toggle-activities');\n            if (tooglebutton) {\n                tooglebutton.addEventListener('click', function(evt) {\n                    var i = 0;\n                    var display = '';\n                    var action = evt.currentTarget.getAttribute('data-action');\n                    switch (action) {\n                        case 'show':\n                            display = 'table-row';\n                            action = 'hide';\n                            break;\n                        case 'hide':\n                            display = 'none';\n                            action = 'show';\n                    }\n\n                    // Affiche ou masque toutes les lignes du tableau des activités.\n                    var rows = document.querySelectorAll('#apsolu-activities-table tbody tr');\n                    for (i = 0; i < rows.length; i++) {\n                        rows[i].style.display = display;\n                    }\n\n                    // Affiche toujours les lignes contenant le nom des activités.\n                    rows = document.getElementsByClassName('apsolu-sports-tr');\n                    for (i = 0; i < rows.length; i++) {\n                        rows[i].style.display = 'table-row';\n                    }\n\n                    // Renseigne l'action à réaliser lors du prochain appel.\n                    evt.currentTarget.setAttribute('data-action', action);\n                });\n            }\n\n            // Lorsqu'on clique sur le lien \"s'inscrire/modifier\"...\n            $('.apsolu-enrol-a').click(function(event) {\n                event.preventDefault();\n\n                var requesturl = $(this).attr('href');\n                requesturl = requesturl.replace('/enrol/select/overview/enrol.php', '/enrol/select/ajax/enrol.php');\n\n                // Affiche le formulaire.\n                $.ajax({\n                    url: requesturl,\n                    type: 'GET',\n                    dataType: 'html'\n                })\n                .done(function(result) {\n                    try {\n                        var error = $.parseJSON(result);\n                        $('#apsolu-enrol-form').html('<div class=\"alert alert-danger\"><p>' + error.error + '</p></div>');\n                    } catch (e) {\n                        $('#apsolu-enrol-form').html(result);\n                    }\n                })/*\n                .fail(function(result) {\n                    console.log('FAIL 1');\n                    var error = $.parseJSON(result);\n                    $('#apsolu-enrol-form').html('<div class=\"alert alert-danger\"><p>'+error.error+'</p></div>');\n                })*/\n                .always(function() {\n                    set_edit_actions();\n                    set_cancel_actions();\n                    set_policy_actions();\n\n                    $('#apsolu-enrol-form').popup('show');\n                });\n                return false;\n            });\n\n            /**\n             * Fonction appelée lorsqu'on clique sur le bouton \"s'inscrire/se désinscrire\"...\n             */\n            function set_edit_actions() {\n                $('#apsolu-enrol-form #id_enrolbutton, #apsolu-enrol-form #id_unenrolbutton, #apsolu-enrol-form #id_editenrol').\n                    click(function(event) {\n                    event.preventDefault();\n\n                    var role = $('#apsolu-enrol-form form select[name=role] option:selected').val();\n                    if (role == undefined) {\n                        role = $('#apsolu-enrol-form form input[name=role]').val();\n                    }\n                    var enrolid = $('#apsolu-enrol-form form input[name=enrolid]').val();\n                    var sesskey = $('#apsolu-enrol-form form input[name=sesskey]').val();\n\n                    var actions;\n                    if ($(this).attr('id') == 'id_unenrolbutton') {\n                        actions = {_qf__enrol_select_form: 1, sesskey: sesskey, enrolid: enrolid, unenrolbutton: 1};\n                    } else if ($(this).attr('id') == 'id_editenrol') {\n                        actions = {_qf__enrol_select_form: 1, sesskey: sesskey, enrolid: enrolid, editenrol: 1, policy: 1};\n                    } else {\n                        var fullname = $('#apsolu-enrol-form form input[name=fullname]').val();\n                        var federation = $('#apsolu-enrol-form form select[name=federation] option:selected').val();\n                        if (federation) {\n                            actions = {\n                                fullname: fullname,\n                                enrolid: enrolid,\n                                role: role,\n                                federation: federation,\n                                enrolbutton: 1,\n                                _qf__enrol_select_form: 1,\n                                sesskey: sesskey,\n                                policy: 1\n                            };\n                        } else {\n                            actions = {\n                                fullname: fullname,\n                                enrolid: enrolid,\n                                role: role,\n                                enrolbutton: 1,\n                                _qf__enrol_select_form: 1,\n                                sesskey: sesskey,\n                                policy: 1\n                            };\n                        }\n                    }\n\n                    $.ajax({\n                            url: wwwroot + \"/enrol/select/ajax/enrol.php\",\n                            type: 'POST',\n                            data: actions,\n                            dataType: 'html'\n                        })\n                        .done(function(result) {\n                            try {\n                                var error = $.parseJSON(result);\n                                $('#apsolu-enrol-form').html('<div class=\"alert alert-danger\"><p>' + error.error + '</p></div>');\n                            } catch (e) {\n                                $('#apsolu-enrol-form').html(result);\n                            }\n                        })/*\n                        .fail(function(result) {\n                            console.log('FAIL');\n                            var error = $.parseJSON(result);\n                            $('#apsolu-enrol-form').html('<div class=\"alert alert-danger\"><p>'+error.error+'</p></div>');\n                        })*/\n                        .always(function() {\n                            set_edit_actions();\n                            set_cancel_actions();\n                            set_policy_actions();\n                            reload_ui(enrolid);\n                        });\n\n                    return false;\n                });\n            }\n\n            /**\n             * Fonction appelée pour définir les actions sur le bouton d'annulation.\n             */\n            function set_cancel_actions() {\n                // Lorsqu'on clique sur le bouton \"annuler\"...\n                $('.apsolu-cancel-a').click(function(event) {\n                    event.preventDefault();\n\n                    $('#apsolu-enrol-form').popup('hide');\n                });\n            }\n\n            /**\n             * Fonction appelée pour désactiver le bouton d'inscription si la case des recommandations médicales n'est pas cochée.\n             */\n            function set_policy_actions() {\n                var policy = $('#apsolu-enrol-form form input[name=policy]');\n\n                // Si la validation des recommandations médicales sont activées.\n                if (policy.length) {\n                    // Désactive le bouton d'inscription.\n                    $('#apsolu-enrol-form form input[name=enrolbutton]').prop('disabled', true);\n\n                    // Active/désactive le bouton d'inscription lorsqu'on coche/décoche la case des recommandations médicales.\n                    policy.change(function() {\n                        if ($(this).is(':checked')) {\n                            $('#apsolu-enrol-form form input[name=enrolbutton]').prop('disabled', false);\n                        } else {\n                            $('#apsolu-enrol-form form input[name=enrolbutton]').prop('disabled', true);\n                        }\n                    });\n                }\n            }\n\n            /**\n             * Fonction appelée pour recharger l'interace graphique.\n             *\n             * @param {string} enrolid Identifiant numérique de la méthode d'inscription.\n             */\n            function reload_ui(enrolid) {\n                // TODO: modifier l'icone edit/add\n\n                // On rafraichit le bloc \"Choix restants\".\n                $.ajax({\n                    url: wwwroot + \"/enrol/select/ajax/reload_block_remaining.php\",\n                    dataType: 'html'\n                })\n                .done(function(result) {\n                    $('#apsolu-select-remaining-ajax').html(result);\n\n                    $('#apsolu-rules-summary').css('display', 'none');\n\n                    $('#apsolu-rules-summary_background, #apsolu-rules-summary_wrapper').remove();\n\n                    $('#apsolu-rules-summary-a').click(function(evt) {\n                        evt.preventDefault();\n\n                        $('#apsolu-rules-summary').css({\n                            backgroundColor: '#EEEEEE',\n                            padding: '.5em',\n                            cursor: 'default',\n                            maxWidth: '50%'\n                        });\n                        $('#apsolu-rules-summary').popup('show');\n                    });\n                })\n                .fail(function() {\n                    // TODO.\n                });\n\n                // On rafraichit le bloc \"Je souhaite m'inscrire à...\".\n                $.ajax({\n                    url: wwwroot + \"/enrol/select/ajax/reload_block_enrolments.php\",\n                    dataType: 'html'\n                })\n                .done(function(result) {\n                    $('#apsolu-select-enrolments-ajax').html(result);\n                })\n                .fail(function() {\n                    // TODO.\n                });\n\n                // On rafraichit la ligne \"Places disponibles\".\n                $.ajax({\n                    url: wwwroot + \"/enrol/select/ajax/reload_column_left_places.php\",\n                    type: 'POST',\n                    data: {enrolid: enrolid},\n                    dataType: 'html'\n                })\n                .done(function(result) {\n                    $('#apsolu-select-left-places-' + enrolid + '-ajax').replaceWith(result);\n                })\n                .fail(function() {\n                    // TODO.\n                });\n\n                // On rafraichit l'icône \"actions\".\n                var img_src = $('.apsolu-enrol-a[data-enrolid=' + enrolid + '] img').attr('src');\n                if ($('.apsolu-enrol-a[data-enrolid=' + enrolid + ']').hasClass('apsolu-enroled-a')) {\n                    $('.apsolu-enrol-a[data-enrolid=' + enrolid + ']').removeClass('apsolu-enroled-a');\n                    $('.apsolu-enrol-a[data-enrolid=' + enrolid + ']').addClass('apsolu-not-enroled-a');\n                    $('.apsolu-enrol-a[data-enrolid=' + enrolid + ']').parent().parent().removeClass('info');\n                    $('.apsolu-enrol-a[data-enrolid=' + enrolid + '] img')\n                        .attr('src', img_src.replace('i/completion-manual-y', 'i/completion-manual-n'));\n                } else {\n                    $('.apsolu-enrol-a[data-enrolid=' + enrolid + ']').removeClass('apsolu-not-enroled-a');\n                    $('.apsolu-enrol-a[data-enrolid=' + enrolid + ']').addClass('apsolu-enroled-a');\n                    $('.apsolu-enrol-a[data-enrolid=' + enrolid + ']').parent().parent().addClass('info');\n                    $('.apsolu-enrol-a[data-enrolid=' + enrolid + '] img')\n                        .attr('src', img_src.replace('i/completion-manual-n', 'i/completion-manual-y'));\n                }\n            }\n        }\n    };\n});\n"],"names":["define","$","initialise","wwwroot","append","tooglebutton","document","getElementById","set_edit_actions","click","event","preventDefault","role","val","undefined","actions","enrolid","sesskey","this","attr","_qf__enrol_select_form","unenrolbutton","editenrol","policy","fullname","federation","enrolbutton","ajax","url","type","data","dataType","done","result","error","parseJSON","html","e","always","set_cancel_actions","set_policy_actions","css","remove","evt","backgroundColor","padding","cursor","maxWidth","popup","fail","replaceWith","img_src","hasClass","removeClass","addClass","parent","replace","reload_ui","length","prop","change","is","addEventListener","i","display","action","currentTarget","getAttribute","rows","querySelectorAll","style","getElementsByClassName","setAttribute","requesturl"],"mappings":"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"}